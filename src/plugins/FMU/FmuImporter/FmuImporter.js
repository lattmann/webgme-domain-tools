/**
* Generated by PluginGenerator from webgme on Mon Apr 28 2014 13:58:17 GMT-0500 (Central Daylight Time).
*/

define(['plugin/PluginConfig', 'plugin/PluginBase'], function (PluginConfig, PluginBase) {
    'use strict';

    /**
    * Initializes a new instance of FmuImporter.
    * @class
    * @augments {PluginBase}
    * @classdesc This class represents the plugin FmuImporter.
    * @constructor
    */
    var FmuImporter = function () {
        // Call base class' constructor.
        PluginBase.call(this);
    };

    // Prototypal inheritance from PluginBase.
    FmuImporter.prototype = Object.create(PluginBase.prototype);
    FmuImporter.prototype.constructor = FmuImporter;

    /**
    * Gets the name of the FmuImporter.
    * @returns {string} The name of the plugin.
    * @public
    */
    FmuImporter.prototype.getName = function () {
        return "FMU Model Importer";
    };

    /**
    * Gets the semantic version (semver.org) of the FmuImporter.
    * @returns {string} The version of the plugin.
    * @public
    */
    FmuImporter.prototype.getVersion = function () {
        return "0.1.0";
    };

    /**
    * Gets the description of the FmuImporter.
    * @returns {string} The description of the plugin.
    * @public
    */
    FmuImporter.prototype.getDescription = function () {
        return "Creates WebGME models for one or more uploaded FMUs";
    };

    /**
    * Gets the configuration structure for the FmuImporter.
    * The ConfigurationStructure defines the configuration for the plugin
    * and will be used to populate the GUI when invoking the plugin from webGME.
    * @returns {object} The version of the plugin.
    * @public
    */
    FmuImporter.prototype.getConfigStructure = function () {
        return [
            {
                "name": "FMU",
                "displayName": "FmuPackage",
                "description": 'Click and drag an existing compiled FMU',
                "value": "", // this is the 'default config'
                "valueType": "asset",
                "readOnly": false
            }
        ];
    };


    /**
    * Main function for the plugin to execute. This will perform the execution.
    * Notes:
    * - Always log with the provided logger.[error,warning,info,debug].
    * - Do NOT put any user interaction logic UI, etc. inside this method.
    * - callback always has to be called even if error happened.
    *
    * @param {function(string, plugin.PluginResult)} mainCallback - the result callback
    */
    FmuImporter.prototype.main = function (mainCallback) {
        // Use self to access core, project, result, logger etc from PluginBase.
        // These are all instantiated at this point.
        var self = this,
            currentConfig = self.getCurrentConfig(),
            currentConfigString = JSON.stringify(currentConfig, null, 4),
            fmuHash = currentConfig.FMU;

        self.logger.debug('Entering FmuImporter main');

        self.logger.debug('CurrentConfig:');
        self.logger.debug(currentConfigString);

        var testDownloadArtifact = self.blobClient.createArtifact('testArtifact');

        var addHashCallback = function (err, fileHash) {
            if (err) {
                self.result.setSuccess(false);
                mainCallback(err, self.result);
                return;
            }

            self.logger.debug('Added hash ' + fileHash + 'to testArtifact.');

            var artifactSaveCallback = function (err, artifactHash) {
                if (err) {
                    self.result.setSuccess(false);
                    mainCallback(err, self.result);
                    return;
                }

                self.result.addArtifact(artifactHash);

                // This will save the changes. If you don't want to save;
                // exclude self.save and call callback directly from this scope.
                self.result.setSuccess(true);
                self.save('Saving FmuImporter results to database...', function (err) {
                    mainCallback(null, self.result);
                });
            };

            testDownloadArtifact.save(artifactSaveCallback);
        };

        testDownloadArtifact.addHash('aNewFmu.fmu', fmuHash, addHashCallback);
    };

    return FmuImporter;
});
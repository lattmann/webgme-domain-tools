<!DOCTYPE html>
<html>
  <head>
    <title>WebGME executor</title>
    <script>
    var config = {
        "server": "localhost",
        "port": "8855",
        "protocol": "http"
    };
    var nodeRequire = require;
    (function() {
        var fs = nodeRequire('fs');
        try {
            var configJSON = fs.readFileSync('config.json', {encoding: 'utf8'});
            config = JSON.parse(configJSON);
        } catch (e) {
            if (e.code !== "ENOENT") {
                throw e;
            }
        }
    })();
    </script>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js">
    </script>

    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>


    <!-- script src="./lib/moment.min.js" type="text/javascript" -->
    <!-- script src="./lib/angular-file-upload-shim.min.js" type="text/javascript" -->

    <script src="https://code.angularjs.org/1.2.18/angular.js" type="text/javascript"></script>
    <script src="https://code.angularjs.org/1.2.18/angular-route.min.js" type="text/javascript"></script>

    <!--script src="/lib/angular-momentjs.js" type="text/javascript" -->

    <!-- link rel="stylesheet" href="./lib/font-awesome/css/font-awesome.min.css" -->

    <!-- script src="./lib/route-styles.js" type="text/javascript" -->
    <!-- script src="./lib/ui-bootstrap-tpls-0.11.0.min.js" type="text/javascript" -->

    <!-- script src="./lib/angular-file-upload.js" type="text/javascript" -->

    <script>
        // getScript require.min.js
        $.ajax({
            url: config.protocol + "://" + config.server + ":" + config.port + "/lib/require/require.min.js",
            cache: true,
            dataType: "script",
            success: function () {
                requirejs([config.protocol + "://" + config.server + ":" + config.port + "/bin/getconfig.js"], function (getconfig) {
                requirejs.config({
                    baseUrl: config.protocol + "://" + config.server + ":" + config.port + '/',
                    paths: {
                        "logManager": 'common/LogManager',
                        "eventDispatcher": 'common/EventDispatcher',
                        "notificationManager": 'js/NotificationManager',
                        "clientUtil": 'js/util',
                        "loaderCircles": "js/Loader/LoaderCircles",
                        "loaderProgressBar": "js/Loader/LoaderProgressBar",
                        "superagent": "lib/superagent/superagent",

                        "codemirror": 'lib/codemirror/codemirror.amd',
                        "jquery-csszoom": 'lib/jquery/jquery.csszoom',

                        "blob": "middleware/blob",

                        // "jszip": 'lib/jszip/jszip',
                        "executor": 'extlib/' + getconfig.paths.executor
                    },
                    nodeRequire: nodeRequire
                });
                // FIXME ugly hack for node-webkit
                var node_modules = ['fs', 'stream', 'path', 'child_process', 'minimatch', 'crypto', 'util', 'mime', 'http', 'https', 'events'];
                node_modules.forEach(function (module_name) {
                    requirejs.s.contexts._.defined[module_name] = nodeRequire(module_name);
                });
                var worker;
                requirejs(['executor/ExecutorWorker', 'executor/JobInfo', 'executor/ExecutorWorkerController'], function (ExecutorWorker, JobInfo, ExecutorWorkerController) {

                    worker = new ExecutorWorker({ server: config.server, serverPort: config.port, httpsecure: config.protocol === 'https', sessionId: undefined });

                    worker.queryWorkerAPI(function (err, response) {
                        var refreshPeriod = 60 * 1000;
                        var callback = function (err, response) {
                            if (err) {
                                document.getElementById('status').style.color = 'white';
                                document.getElementById('status').style.backgroundColor = 'red';
                                document.getElementById('status').textContent = err;
                            } else {
                                document.getElementById('status').style.color = 'white';
                                document.getElementById('status').style.backgroundColor = 'green';
                                document.getElementById('status').textContent = 'OK';
                            }
                            if (response && response.refreshPeriod) {
                                refreshPeriod = response.refreshPeriod;
                            }
                            var timeoutID = window.setTimeout(function () {
                                worker.queryWorkerAPI(callback);
                            }, refreshPeriod);
                        };
                        callback(err, response);
                    });

                    var WebGMEApp = angular.module('WebGMEApp', ['ngRoute']);
                    WebGMEApp.value("worker", worker);
//                  WebGMEApp.value("worker", null);
                    WebGMEApp.controller('ExecutorWorkerController', ExecutorWorkerController);
                    /*WebGMEApp.config(['$routeProvider',
                     function ($routeProvider) {
                     $routeProvider.
                     when('/executor', {
                     templateUrl: 'app/workspace/views/WorkspaceView.html',
                     // css: 'app/workspace/styles/Workspace.css',
                     controller: 'ExecutorWorkerController'
                     }).
                     otherwise({
                     redirectTo: '/executor'
                     });
                     }]);
                     */

                    angular.bootstrap(document, ['WebGMEApp']);

                    // TODO: authentication?
                });
            });
        },
        error: function(jqxhr, settings, exception) {
            // FIXME this doesn't fire
            $("#status").text("Failed to connect");
        }});
    </script>
  </head>
  <body>
  <div class="container">
    <div class="row" id="main">
        <div class="col-md-12" id="status">Connecting...</div>
        <div class="col-md-12" id="jobs"></div>
    </div>

    <!-- div data-ng-view="" -->
    <div class="row" data-ng-controller="ExecutorWorkerController">
        <div class="col-md-12">
            <ul>
                <li data-ng-repeat="job in jobs">{{job.hash}} {{job.status}} {{job.name}} {{job.url}} {{job.resultHash}}</li>
            </ul>
        </div>
    </div>
    <small>node.js <script>document.write(process.version)</script></small>
  </div>
  </body>
</html>
